# ===============================================
# ‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏£‡∏±‡∏ô‡πÄ‡∏ó‡∏™‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
# ===============================================

# ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô GitHub
name: Web Test Auto Run

# ===============================================
# ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏£‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà
# ===============================================
on:
  # ‡∏£‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ push code ‡πÑ‡∏õ‡∏ó‡∏µ‡πà branch main
  push:
    branches: [ main ]
  
  # ‡∏£‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏±‡∏ô‡πÄ‡∏≠‡∏á‡πÉ‡∏ô GitHub
  workflow_dispatch:

# ===============================================
# ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ó‡∏≥
# ===============================================
jobs:
  # ‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô: test-web
  test-web:
    # ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå Ubuntu (Linux) ‡∏Ç‡∏≠‡∏á GitHub
    runs-on: ubuntu-latest
    
    # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    steps:
      # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏î‡∏∂‡∏á code ‡∏à‡∏≤‡∏Å GitHub
      - name: ‡∏î‡∏∂‡∏á code ‡∏°‡∏≤
        uses: actions/checkout@v4
      
      # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Python
      - name: ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12.4'
      
      # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Robot Framework
      - name: ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Robot Framework
        run: |
          pip install -r requirements.txt

      # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 4: ‡∏£‡∏±‡∏ô‡πÄ‡∏ó‡∏™
      - name: üß™ Run Web Tests Only
        run: |
          mkdir -p results
          
          # ‡∏£‡∏±‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Web Tests - ‡∏°‡∏µ 3 ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:
          
          # ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 1: ‡∏£‡∏±‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Web
          robot \
            --variable BROWSER:headlesschrome \
            --outputdir results \
            --output output.xml \
            --log log.html \
            --report report.html \
            --name "Web Tests" \
            TestScript/Web/Staging/FlowLogin.robot || true
          
          # ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ô
          echo "================================"
          echo "Test execution completed with exit code: ${EXIT_CODE:-0}"
          echo "================================"
     
      - name: üìä Generate Test Summary Report
        if: always()
        run: |
          # ‡∏™‡∏£‡πâ‡∏≤‡∏á Python script ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏•
          cat > analyze_results.py << 'PYTHON_SCRIPT'
          import xml.etree.ElementTree as ET
          import os
          import json
          
          def analyze_robot_results():
              xml_file = 'results/output.xml'
              
              if not os.path.exists(xml_file):
                  print("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö")
                  return
              
              try:
                  tree = ET.parse(xml_file)
                  root = tree.getroot()
                  
                  # ‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏Å
                  stats = root.find('.//statistics/total/stat')
                  if stats is None:
                      print("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå")
                      return
                  
                  # ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Pass/Fail/Skip
                  passed = int(stats.get('pass', 0))
                  failed = int(stats.get('fail', 0))
                  skipped = int(stats.get('skip', 0))
                  total = passed + failed + skipped
                  
                  # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå
                  pass_percentage = (passed / total * 100) if total > 0 else 0
                  fail_percentage = (failed / total * 100) if total > 0 else 0
                  
                  # ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô Console
                  print("\n" + "="*60)
                  print("üìä WEB TEST EXECUTION SUMMARY")
                  print("="*60)
                  print(f"‚úÖ PASSED:  {passed:3d} tests ({pass_percentage:6.2f}%)")
                  print(f"‚ùå FAILED:  {failed:3d} tests ({fail_percentage:6.2f}%)")
                  if skipped > 0:
                      skip_percentage = (skipped / total * 100)
                      print(f"‚è≠Ô∏è  SKIPPED: {skipped:3d} tests ({skip_percentage:6.2f}%)")
                  print("-"*60)
                  print(f"üìä TOTAL:   {total:3d} tests (100.00%)")
                  print(f"üìà PASS RATE: {pass_percentage:.2f}%")
                  print("="*60)
                  
                  # ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°
                  if pass_percentage == 100:
                      print("\nüéâ EXCELLENT! All tests passed!")
                      status_emoji = "üéâ"
                      status_text = "Perfect"
                  elif pass_percentage >= 80:
                      print("\n‚úÖ GOOD! Most tests passed")
                      status_emoji = "‚úÖ"
                      status_text = "Good"
                  elif pass_percentage >= 60:
                      print("\n‚ö†Ô∏è  WARNING! Several tests failed")
                      status_emoji = "‚ö†Ô∏è"
                      status_text = "Warning"
                  else:
                      print("\n‚ùå CRITICAL! Many tests failed")
                      status_emoji = "‚ùå"
                      status_text = "Critical"
                  
                  # ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Test ‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô
                  print("\n" + "="*60)
                  print("üìã TEST DETAILS")
                  print("="*60)
                  
                  passed_tests = []
                  failed_tests = []
                  
                  for test in root.findall('.//test'):
                      test_name = test.get('name', 'Unknown')
                      test_status = test.get('status', 'UNKNOWN')
                      
                      if test_status == 'PASS':
                          passed_tests.append(test_name)
                      elif test_status == 'FAIL':
                          failed_tests.append(test_name)
                          # ‡∏´‡∏≤ error message
                          msg = test.find('.//msg[@level="FAIL"]')
                          error_msg = msg.text if msg is not None and msg.text else "No error message"
                          failed_tests.append(f"  ‚îî‚îÄ Error: {error_msg[:100]}")
                  
                  # ‡πÅ‡∏™‡∏î‡∏á Passed Tests
                  if passed_tests:
                      print(f"\n‚úÖ PASSED TESTS ({len([t for t in passed_tests if not t.startswith('  ')])} tests):")
                      print("-"*40)
                      for test in passed_tests[:10]:  # ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Ñ‡πà 10 ‡∏≠‡∏±‡∏ô‡πÅ‡∏£‡∏Å
                          print(f"  ‚úì {test}")
                      if len(passed_tests) > 10:
                          print(f"  ... and {len(passed_tests)-10} more")
                  
                  # ‡πÅ‡∏™‡∏î‡∏á Failed Tests
                  if failed_tests:
                      print(f"\n‚ùå FAILED TESTS ({failed} tests):")
                      print("-"*40)
                      for test in failed_tests:
                          if test.startswith('  '):
                              print(test)
                          else:
                              print(f"  ‚úó {test}")
                  
                  # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå JSON ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Badge
                  badge_data = {
                      "passed": passed,
                      "failed": failed,
                      "skipped": skipped,
                      "total": total,
                      "pass_rate": round(pass_percentage, 2),
                      "status": status_text
                  }
                  
                  with open('results/test_summary.json', 'w') as f:
                      json.dump(badge_data, f, indent=2)
                  
                  # ‡∏™‡∏£‡πâ‡∏≤‡∏á Markdown ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö GitHub Summary
                  with open('test_summary.md', 'w') as f:
                      f.write(f"# {status_emoji} Web Test Results\n\n")
                      
                      # ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ
                      f.write("## üìä Summary\n\n")
                      f.write("| Status | Count | Percentage | Progress Bar |\n")
                      f.write("|--------|-------|------------|-------------|\n")
                      
                      # Progress bar ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Pass
                      pass_bar = 'üü©' * int(pass_percentage/10) + '‚¨ú' * (10-int(pass_percentage/10))
                      f.write(f"| ‚úÖ **Passed** | **{passed}** | **{pass_percentage:.2f}%** | {pass_bar} |\n")
                      
                      # Progress bar ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Fail
                      fail_bar = 'üü•' * int(fail_percentage/10) + '‚¨ú' * (10-int(fail_percentage/10))
                      f.write(f"| ‚ùå **Failed** | **{failed}** | **{fail_percentage:.2f}%** | {fail_bar} |\n")
                      
                      if skipped > 0:
                          skip_percentage = (skipped / total * 100)
                          skip_bar = 'üü®' * int(skip_percentage/10) + '‚¨ú' * (10-int(skip_percentage/10))
                          f.write(f"| ‚è≠Ô∏è **Skipped** | **{skipped}** | **{skip_percentage:.2f}%** | {skip_bar} |\n")
                      
                      f.write(f"| üìä **Total** | **{total}** | **100.00%** | üîµüîµüîµüîµüîµüîµüîµüîµüîµüîµ |\n\n")
                      
                      # Badge
                      color = 'brightgreen' if pass_percentage >= 80 else 'yellow' if pass_percentage >= 60 else 'red'
                      f.write(f"![Tests](https://img.shields.io/badge/Tests-{passed}%20passed%2C%20{failed}%20failed-{color})\n")
                      f.write(f"![Pass Rate](https://img.shields.io/badge/Pass%20Rate-{pass_percentage:.1f}%25-{color})\n\n")
                      
                      # Test Details
                      if failed > 0:
                          f.write("## ‚ùå Failed Tests\n\n")
                          f.write("| Test Name | Error |\n")
                          f.write("|-----------|-------|\n")
                          for i in range(0, len(failed_tests), 2):
                              if not failed_tests[i].startswith('  '):
                                  error = failed_tests[i+1].replace('  ‚îî‚îÄ Error: ', '') if i+1 < len(failed_tests) else 'N/A'
                                  f.write(f"| {failed_tests[i]} | {error[:50]}... |\n")
                      
                      # ‡∏™‡∏£‡πâ‡∏≤‡∏á Chart ‡πÅ‡∏ö‡∏ö ASCII
                      f.write("\n## üìà Visual Summary\n\n")
                      f.write("```\n")
                      f.write("Pass Rate Chart:\n")
                      f.write(f"[{'‚ñà' * int(pass_percentage/2)}{' ' * (50-int(pass_percentage/2))}] {pass_percentage:.1f}%\n")
                      f.write("\nTest Distribution:\n")
                      f.write(f"Passed : {'‚úÖ' * min(passed, 20)}\n")
                      f.write(f"Failed : {'‚ùå' * min(failed, 20)}\n")
                      if skipped > 0:
                          f.write(f"Skipped: {'‚è≠Ô∏è' * min(skipped, 20)}\n")
                      f.write("```\n")
                  
                  print("\n‚úÖ Summary files created successfully!")
                  
                  # Set output variables for GitHub Actions
                  print(f"::set-output name=total::{total}")
                  print(f"::set-output name=passed::{passed}")
                  print(f"::set-output name=failed::{failed}")
                  print(f"::set-output name=pass_rate::{pass_percentage:.2f}")
                  
              except Exception as e:
                  print(f"‚ùå Error analyzing results: {str(e)}")
          
          if __name__ == "__main__":
              analyze_robot_results()
          PYTHON_SCRIPT
          
          # ‡∏£‡∏±‡∏ô script ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏•
          python analyze_results.py
      
      - name: üìù Update GitHub Job Summary
        if: always()
        run: |
          # ‡πÄ‡∏û‡∏¥‡πà‡∏° Summary ‡πÉ‡∏ô GitHub
          if [ -f "test_summary.md" ]; then
            cat test_summary.md >> $GITHUB_STEP_SUMMARY
            
            # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üìå Test Information" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Run Number:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Runner:** ${{ runner.os }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üîó Quick Links" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- [üì• Download Full Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
            echo "- [üìä View Test Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/jobs)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è No test summary available" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: üè∑Ô∏è Set Job Status Badge
        if: always()
        run: |
          # ‡∏≠‡πà‡∏≤‡∏ô‡∏ú‡∏•‡∏à‡∏≤‡∏Å JSON ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á badge
          if [ -f "results/test_summary.json" ]; then
            python << 'EOF'
          import json
          
          with open('results/test_summary.json', 'r') as f:
              data = json.load(f)
          
          # ‡∏™‡∏£‡πâ‡∏≤‡∏á badge URL
          passed = data['passed']
          failed = data['failed']
          total = data['total']
          pass_rate = data['pass_rate']
          
          print(f"\nüè∑Ô∏è Test Badge:")
          print(f"![Tests](https://img.shields.io/badge/Tests-{passed}%2F{total}%20passed-{'green' if failed == 0 else 'red'})")
          print(f"![Pass Rate](https://img.shields.io/badge/Pass%20Rate-{pass_rate}%25-{'green' if pass_rate >= 80 else 'yellow' if pass_rate >= 60 else 'red'})")
          EOF
          fi
      
      - name: üìÅ Upload Test Results with Summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: web-test-results-${{ github.run_number }}
          path: |
            results/
            test_summary.md
          retention-days: 30