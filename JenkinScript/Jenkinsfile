pipeline {
    agent any
    
    // Parameters ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ô
    parameters {
        choice(name: 'TEST_SUITE', 
               choices: ['all', 'api', 'web', 'mobile'], 
               description: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å test suite ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏£‡∏±‡∏ô')
        string(name: 'BROWSER', 
               defaultValue: 'chrome', 
               description: 'Browser ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö web tests (chrome, firefox, edge)')
        booleanParam(name: 'SKIP_MOBILE', 
                     defaultValue: false, 
                     description: '‡∏Ç‡πâ‡∏≤‡∏° mobile tests ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ Appium server')
        booleanParam(name: 'PARALLEL_EXECUTION', 
                     defaultValue: false, 
                     description: '‡∏£‡∏±‡∏ô tests ‡πÅ‡∏ö‡∏ö parallel')
    }
    
    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Environment ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ô Pipeline
    environment {
        ROBOT_OPTIONS = '--outputdir results --loglevel INFO --timestampoutputs'
        APPIUM_SERVER = 'http://localhost:4723/wd/hub'
        PYTHON_PATH = 'python'
        BUILD_TIMESTAMP = "${new Date().format('yyyy-MM-dd_HH-mm-ss')}"
    }
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£ Build ‡πÅ‡∏•‡∏∞ Options ‡∏ï‡πà‡∏≤‡∏á‡πÜ
    options {
        timeout(time: 30, unit: 'MINUTES')
        skipDefaultCheckout(false)
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
    }
    
    stages {
        // Stage 1: ‡∏î‡∏∂‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏≤‡∏Å Git Repository
        stage('Checkout Code From Git') {
            steps {
                echo 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏≤‡∏Å Git repository...'
                
                git branch: 'main',
                    url: 'https://github.com/kaakom100/TTB-Automation-Assignment'
                    
                script {
                    def commitInfo = bat(script: 'git log -1 --pretty=format:"%h - %an: %s"', returnStdout: true).trim()
                    echo "üìù Commit ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${commitInfo}"
                }
            }
        }
        
        // Stage 2: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Environment ‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö
        stage('Environment Setup') {
            steps {
                echo '‚öôÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Python environment...'
                script {
                    try {
                        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô Python
                        bat 'python --version'
                        echo '‚úÖ Python ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'
                        
                        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå results ‡∏û‡∏£‡πâ‡∏≠‡∏° subdirectories
                        bat '''
                            if not exist "results" mkdir results
                            if not exist "results\\api" mkdir results\\api
                            if not exist "results\\web" mkdir results\\web
                            if not exist "results\\mobile" mkdir results\\mobile
                            if not exist "results\\merged" mkdir results\\merged
                            if not exist "results\\screenshots" mkdir results\\screenshots
                        '''
                        echo 'üìÅ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'
                        
                        // ‡∏≠‡∏±‡∏û‡πÄ‡∏Å‡∏£‡∏î pip
                        bat 'python -m pip install --upgrade pip'
                        echo '‚¨ÜÔ∏è ‡∏≠‡∏±‡∏û‡πÄ‡∏Å‡∏£‡∏î pip ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'
                        
                    } catch (Exception e) {
                        error "‚ùå ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ environment ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${e.getMessage()}"
                    }
                }
            }
        }
        
        // Stage 3: ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Dependencies
        stage('Install Dependencies') {
            steps {
                echo 'üì¶ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Python dependencies...'
                script {
                    try {
                        bat 'pip install -r JenkinScript/requirements.txt'
                        echo '‚úÖ ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á dependencies ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'
                        
                        echo 'üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Robot Framework packages:'
                        bat 'pip list | findstr robot'
                        
                    } catch (Exception e) {
                        error "‚ùå ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á dependencies ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${e.getMessage()}"
                    }
                }
            }
        }
        
        // Stage 4: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Test Files ‡πÅ‡∏•‡∏∞ Environment
        stage('Pre-Test Validation') {
            steps {
                echo 'üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö test environment...'
                script {
                    try {
                        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö configuration files
                        def configFiles = [
                            'Configuration\\Configs_Run_Test_Global.yml',
                            'Configuration\\Configs_Timeout.yml',
                            'Resource\\KeyRepositories.yml'
                        ]
                        
                        configFiles.each { file ->
                            if (bat(script: "if exist \"${file}\" (exit 0) else (exit 1)", returnStatus: true) != 0) {
                                error "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå: ${file}"
                            }
                        }
                        echo '‚úÖ ‡πÑ‡∏ü‡∏•‡πå configuration ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'
                        
                        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö test files
                        def testSuites = ['API', 'Web', 'Mobile']
                        testSuites.each { suite ->
                            def count = bat(
                                script: "dir /b TestScript\\${suite}\\*.robot 2>nul | find /c \".robot\"",
                                returnStdout: true
                            ).trim()
                            echo "üìä ‡∏û‡∏ö ${count} test files ‡πÉ‡∏ô ${suite} suite"
                        }
                        
                        echo 'üéØ ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö environment ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå'
                        
                    } catch (Exception e) {
                        error "‚ùå ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏£‡∏±‡∏ô test ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${e.getMessage()}"
                    }
                }
            }
        }
        
        // Stage 5: ‡∏£‡∏±‡∏ô Tests (Sequential ‡∏´‡∏£‡∏∑‡∏≠ Parallel)
        stage('Execute Tests') {
            when {
                expression { params.PARALLEL_EXECUTION == false }
            }
            steps {
                script {
                    // ‡∏£‡∏±‡∏ô API Tests
                    if (params.TEST_SUITE in ['all', 'api']) {
                        runApiTests()
                    }
                    
                    // ‡∏£‡∏±‡∏ô Web Tests
                    if (params.TEST_SUITE in ['all', 'web']) {
                        runWebTests()
                    }
                    
                    // ‡∏£‡∏±‡∏ô Mobile Tests
                    if (params.TEST_SUITE in ['all', 'mobile'] && !params.SKIP_MOBILE) {
                        runMobileTests()
                    }
                }
            }
        }
        
        // Stage 5 Alternative: Parallel Execution
        stage('Execute Tests in Parallel') {
            when {
                expression { params.PARALLEL_EXECUTION == true }
            }
            parallel {
                stage('API Tests') {
                    when {
                        expression { params.TEST_SUITE in ['all', 'api'] }
                    }
                    steps {
                        script { runApiTests() }
                    }
                }
                
                stage('Web Tests') {
                    when {
                        expression { params.TEST_SUITE in ['all', 'web'] }
                    }
                    steps {
                        script { runWebTests() }
                    }
                }
                
                stage('Mobile Tests') {
                    when {
                        expression { 
                            params.TEST_SUITE in ['all', 'mobile'] && 
                            !params.SKIP_MOBILE 
                        }
                    }
                    steps {
                        script { runMobileTests() }
                    }
                }
            }
        }
        
        // Stage 6: ‡∏£‡∏ß‡∏°‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å Test Suite
        stage('Merge Test Results') {
            steps {
                echo 'üîó ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏ß‡∏°‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å test suite...'
                script {
                    try {
                        def outputFiles = []
                        
                        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ output files ‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á
                        ['api', 'web', 'mobile'].each { suite ->
                            if (fileExists("results/${suite}/output.xml")) {
                                outputFiles.add("results/${suite}/output.xml")
                                echo "‚úÖ ‡∏û‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ${suite.toUpperCase()} tests"
                            }
                        }
                        
                        // ‡∏£‡∏ß‡∏°‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 ‡πÑ‡∏ü‡∏•‡πå
                        if (outputFiles.size() > 1) {
                            def files = outputFiles.join(' ')
                            bat """
                                rebot --outputdir results/merged ^
                                      --name "Complete_Test_Suite" ^
                                      --reporttitle "Test Report - Build #${BUILD_NUMBER}" ^
                                      --logtitle "Test Log - ${BUILD_TIMESTAMP}" ^
                                      ${files}
                            """
                            echo '‚úÖ ‡∏£‡∏ß‡∏°‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'
                        } else if (outputFiles.size() == 1) {
                            echo 'üìå ‡∏°‡∏µ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏û‡∏µ‡∏¢‡∏á 1 suite ‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏°'
                        } else {
                            echo '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå test ‡πÉ‡∏î‡πÜ'
                        }
                        
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏°‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: ${e.getMessage()}"
                    }
                }
            }
        }
        
        // Stage 7: ‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÅ‡∏•‡∏∞ Reports
        stage('Publish Test Results') {
            steps {
                echo 'üìä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà test results ‡πÅ‡∏•‡∏∞ reports...'
                script {
                    try {
                        // Archive artifacts
                        echo 'üìÅ ‡∏Å‡∏≥‡∏•‡∏±‡∏á archive artifacts...'
                        archiveArtifacts artifacts: '''
                            results/**/*.xml,
                            results/**/*.html,
                            results/**/*.png,
                            results/**/*.jpg,
                            results/**/*.log
                        ''', allowEmptyArchive: true, fingerprint: true
                        
                        // Publish HTML Reports
                        echo 'üìÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà HTML reports...'
                        
                        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ merged report ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ merged report
                        def reportDir = fileExists('results/merged/report.html') ? 'results/merged' : 'results'
                        
                        publishHTML([
                            allowMissing: false,
                            alwaysLinkToLastBuild: true,
                            keepAll: true,
                            reportDir: reportDir,
                            reportFiles: '**/report.html',
                            reportName: 'Robot Framework Test Report',
                            reportTitles: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö'
                        ])
                        
                        // Robot Framework Plugin
                        try {
                            echo 'ü§ñ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ Robot Framework plugin...'
                            robot outputPath: reportDir,
                                  reportFileName: 'report.html',
                                  logFileName: 'log.html',
                                  passThreshold: 80.0,
                                  unstableThreshold: 70.0,
                                  criticalFailedThreshold: 90.0,
                                  otherFiles: '**/*.png,**/*.jpg'
                        } catch (Exception robotPluginError) {
                            echo "‚ö†Ô∏è Robot Framework plugin ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: ${robotPluginError.getMessage()}"
                        }
                        
                        echo '‚úÖ ‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'
                        
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${e.getMessage()}"
                    }
                }
            }
        }
        
        // Stage 8: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö
        stage('Test Summary') {
            steps {
                echo 'üìã ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö...'
                script {
                    try {
                        // ‡∏™‡∏£‡πâ‡∏≤‡∏á summary report
                        def summaryContent = """
=====================================
        ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö
=====================================
Build Number: ${BUILD_NUMBER}
Build URL: ${BUILD_URL}
Test Suite: ${params.TEST_SUITE}
Browser: ${params.BROWSER}
Parallel Execution: ${params.PARALLEL_EXECUTION}
Skip Mobile: ${params.SKIP_MOBILE}
‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ô: ${BUILD_TIMESTAMP}
Jenkins Node: ${NODE_NAME ?: 'N/A'}
=====================================
"""
                        writeFile file: 'results/summary.txt', text: summaryContent
                        
                        // ‡πÅ‡∏™‡∏î‡∏á summary
                        echo "üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö:\n${summaryContent}"
                        
                        // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô test cases
                        ['api', 'web', 'mobile'].each { suite ->
                            if (fileExists("results/${suite}/output.xml")) {
                                echo "üìà ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ${suite.toUpperCase()} tests..."
                            }
                        }
                        
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${e.getMessage()}"
                    }
                }
            }
        }
    }
    
    // Post Actions
    post {
        always {
            echo 'üèÅ Pipeline execution ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'
            
            script {
                try {
                    echo 'üßπ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß...'
                    bat '''
                        if exist "selenium-screenshot-*.png" del selenium-screenshot-*.png
                        if exist "*.log" del *.log
                        if exist "geckodriver.log" del geckodriver.log
                    '''
                    echo '‚úÖ ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'
                } catch (Exception e) {
                    echo "‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î: ${e.getMessage()}"
                }
            }
        }
        
        success {
            echo 'üéâ Pipeline ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!'
            echo '‚úÖ ‡∏ó‡∏∏‡∏Å tests ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞ results ‡∏ñ‡∏π‡∏Å‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡πÅ‡∏•‡πâ‡∏ß'
            
            // ‡∏™‡πà‡∏á notification (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
            script {
                def duration = currentBuild.durationString.replace(' and counting', '')
                echo "‚è±Ô∏è ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${duration}"
            }
        }
        
        unstable {
            echo '‚ö†Ô∏è Pipeline ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏ï‡πà‡∏°‡∏µ test failures'
            echo 'üìä ‡∏ö‡∏≤‡∏á tests ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö report'
        }
        
        failure {
            echo '‚ùå Pipeline ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß!'
            echo 'üîç ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö console output ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'
        }
        
        cleanup {
            echo 'üßπ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î workspace...'
            // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ results ‡πÑ‡∏ß‡πâ
            /*
            cleanWs(
                cleanWhenNotBuilt: false,
                deleteDirs: true,
                disableDeferredWipeout: true,
                notFailBuild: true,
                patterns: [[pattern: 'results/**', type: 'EXCLUDE']]
            )
            */
        }
    }
}

// ==================== Helper Functions ====================

def runApiTests() {
    echo 'üåê ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ô API tests...'
    try {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ test files ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        def testCount = bat(
            script: 'dir /b TestScript\\API\\*.robot 2>nul | find /c ".robot"',
            returnStdout: true
        ).trim()
        
        if (testCount == "0") {
            echo '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö API test files - ‡∏Ç‡πâ‡∏≤‡∏°'
            return
        }
        
        echo "üìä ‡∏û‡∏ö ${testCount} API test files"
        
        // ‡∏£‡∏±‡∏ô tests
        def result = bat(
            script: 'robot --include api --outputdir results/api --name "API_Tests" TestScript/API/*.robot',
            returnStatus: true
        )
        
        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
        handleTestResult(result, 'API')
        
    } catch (Exception e) {
        echo "‚ö†Ô∏è API tests ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: ${e.getMessage()}"
        currentBuild.result = 'UNSTABLE'
    }
}

def runWebTests() {
    echo 'üñ•Ô∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ô Web automation tests...'
    try {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ test files ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        def testCount = bat(
            script: 'dir /b TestScript\\Web\\*.robot 2>nul | find /c ".robot"',
            returnStdout: true
        ).trim()
        
        if (testCount == "0") {
            echo '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö Web test files - ‡∏Ç‡πâ‡∏≤‡∏°'
            return
        }
        
        echo "üìä ‡∏û‡∏ö ${testCount} Web test files"
        
        // ‡∏£‡∏±‡∏ô tests ‡∏û‡∏£‡πâ‡∏≠‡∏° browser parameter
        def browser = params.BROWSER ?: 'chrome'
        def result = bat(
            script: """robot --variable BROWSER:${browser} ^
                            --outputdir results/web ^
                            --name "Web_Tests" ^
                            TestScript/Web/*.robot""",
            returnStatus: true
        )
        
        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
        handleTestResult(result, 'Web')
        
    } catch (Exception e) {
        echo "‚ö†Ô∏è Web tests ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: ${e.getMessage()}"
        currentBuild.result = 'UNSTABLE'
    }
}

def runMobileTests() {
    echo 'üì± ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Appium server...'
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Appium server
    def appiumReady = bat(
        script: 'curl -s http://localhost:4723/wd/hub/status',
        returnStatus: true
    ) == 0
    
    if (!appiumReady) {
        echo '‚ö†Ô∏è Appium server ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° - ‡∏Ç‡πâ‡∏≤‡∏° Mobile tests'
        return
    }
    
    echo '‚úÖ Appium server ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'
    echo 'üì± ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ô Mobile automation tests...'
    
    try {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ test files ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        def testCount = bat(
            script: 'dir /b TestScript\\Mobile\\*.robot 2>nul | find /c ".robot"',
            returnStdout: true
        ).trim()
        
        if (testCount == "0") {
            echo '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö Mobile test files - ‡∏Ç‡πâ‡∏≤‡∏°'
            return
        }
        
        echo "üìä ‡∏û‡∏ö ${testCount} Mobile test files"
        
        // ‡∏£‡∏±‡∏ô tests
        def result = bat(
            script: 'robot --outputdir results/mobile --name "Mobile_Tests" TestScript/Mobile/*.robot',
            returnStatus: true
        )
        
        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
        handleTestResult(result, 'Mobile')
        
    } catch (Exception e) {
        echo "‚ö†Ô∏è Mobile tests ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: ${e.getMessage()}"
        currentBuild.result = 'UNSTABLE'
    }
}

def handleTestResult(exitCode, testType) {
    switch(exitCode) {
        case 0:
            echo "‚úÖ ${testType} tests ‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"
            break
        case 1:
            echo "‚ö†Ô∏è ${testType} tests ‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß"
            currentBuild.result = 'UNSTABLE'
            break
        case [250..255]:
            error "üí• ${testType} tests ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á (exit code: ${exitCode})"
            break
        default:
            echo "‚ö†Ô∏è ${testType} tests ‡∏à‡∏ö‡∏î‡πâ‡∏ß‡∏¢ exit code: ${exitCode}"
            currentBuild.result = 'UNSTABLE'
    }
}